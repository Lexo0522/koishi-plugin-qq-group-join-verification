# koishi-plugin-qq-group-join-verification

Koishi 插件，用于 QQ 群加群验证，支持多适配器、多群独立配置、图片验证码、超时拒绝、白名单、数据库持久化、Console 可视化后台。

## 📋 更新记录

### v1.0.41
- 全局清理 console 引用：
  - 移除 `export const inject = ['console']` 声明
  - 清理所有 console 服务相关代码，简化插件初始化逻辑
  - 减少插件依赖，提高加载速度

### v1.0.40
- 命令系统修复：
  - 修复所有命令动作函数的参数模式，从直接使用 `session` 对象改为使用包含 `session` 属性的上下文对象
  - 对于带参数的命令，通过 `ctx.args` 获取命令参数
  - 确保所有命令都能正确执行，不再显示帮助信息
  - 修复了 `verify enable`、`verify disable` 等命令的执行问题

### v1.0.39
- 命令系统优化：
  - 重构命令注册方式，使用正确的子命令注册模式
  - 修复命令动作函数签名，确保与 Koishi v4 命令系统兼容
  - 优化权限检查逻辑，确保超级管理员验证正确

### v1.0.32
- 命令兼容性修复：
  - 修复命令注册中的群ID获取问题，支持从 `channelId`、`group_id`、`groupId` 等多种字段获取群ID
  - 确保命令在不同适配器下都能正确识别群聊环境
  - 优化错误提示，当无法获取群ID时明确提示"请在群内使用此命令"

### v1.0.31
- 控制台功能增强：
  - 在控制台配置页面添加"开启群聊验证"开关，支持一键启用/禁用验证功能
  - 实现验证状态与验证模式的联动，关闭验证时自动禁用模式选择
  - 优化用户体验，添加操作反馈和错误处理

### v1.0.30
- 依赖声明修复：
  - 添加 `export const inject = ['console']` 声明，解决 Koishi 控制台服务未注册警告
  - 确保控制台服务在插件初始化前正确初始化

### v1.0.29
- 跨数据库兼容修复：
  - 移除 `db.extend()` 调用，避免因数据库驱动类型不兼容导致的初始化失败
  - 实现表存在检测机制，使用安全的访问方式
  - 添加客户端过滤、排序、分页处理，提高兼容性
  - 确保插件在不同数据库驱动下都能正常运行

### v1.0.24
- 重要修复：
  - 修复数据库模型定义格式，移除 `as const` 断言，解决 Minato 库的 Object.entries() 错误
  - 修正动态默认值的定义格式，将箭头函数改为普通函数，确保上下文正确
  - 确保数据库模型定义符合 Minato 库的规范，避免初始化错误

### v1.0.23
- 稳定性优化：
  - 在 DatabaseService 构造函数中添加数据库服务存在性检查，避免空指针错误
  - 增强插件的容错能力，确保在数据库服务不可用时能够给出明确错误信息

### v1.0.22
- 功能增强：
  - 添加 `verify help` 指令，显示完整的指令帮助信息
  - 添加 `verify status` 指令，查看当前群验证状态详情
  - 完善指令系统，确保所有指令都有清晰的帮助信息

### v1.0.21
- 核心优化：
  - 实现图片验证码发送失败时自动降级为文本验证码的功能
  - 添加插件卸载时的定时器清理逻辑，防止内存泄漏
  - 实现重复请求处理，复用原有验证码并重置超时定时器
  - 完善图片验证码发送逻辑，支持发送 SVG 格式的图片
  - 为 VerifyRecord 表添加索引，提升查询性能
  - 实现验证记录的分页查询功能，支持按时间倒序排序

### v1.0.20
- 版本更新：
  - 更新版本号为 1.0.20，正式发布新版本
  - 优化 README.md 文档，添加数据库初始化错误修复的详细说明
  - 确保文档与代码实现保持一致

### v1.0.19
- 版本更新：
  - 更新版本号为 1.0.19，正式发布新版本
  - 优化 README.md 文档，添加本地开发和测试指南
  - 更新技术实现部分的版本信息，与依赖配置保持一致
  - 完善目录结构说明，添加新文件的说明
  - 修复构建配置，确保插件能够正确编译和发布
- 重要修复：
  - 修复数据库初始化错误：将数据库模型从类改为配置对象，解决 Object.entries() 错误
  - 更新数据库服务实现，确保正确初始化和使用数据库模型
  - 修复 GroupConfig 实例创建方式，改为使用普通对象
  - 确保插件能够正确加载和初始化数据库服务

### v1.0.18
- 全面重构插件代码：
  - 优化代码结构，拆分过长方法，提高可读性和可维护性
  - 完善类型定义，创建独立的 types 目录
  - 改进 Console 注册方式，使用更安全的类型检查
  - 扩展配置项，增加更多功能选项
  - 添加缓存机制，优化性能，减少数据库查询
  - 加强安全性，添加验证码尝试次数限制
  - 更新依赖项版本到最新版本
  - 修复构建配置，解决 TypeScript 编译错误

### v1.0.9
- 更新消息事件处理：
  - 将消息监听从 `message/group` 改为 `message-created` 事件，支持最新的消息事件格式
  - 优化消息处理逻辑，只处理群消息且内容不为空的消息
  - 保持向后兼容，确保在不同适配器中都能正常工作

### v1.0.8
- 添加对新事件格式的支持：
  - 支持 `guild-member-request` 事件，确保能够正确处理新的加群请求格式
  - 保持对原有事件格式的兼容
- 优化事件解析逻辑，提高适配性

### v1.0.7
- 优化构建配置：
  - 改回使用 TypeScript 源码（src目录），避免构建错误
  - 移除不存在的 @types/svg-captcha 依赖
  - 确保插件能够正确加载和运行

### v1.0.6
- 优化构建配置：
  - 改为使用编译后的代码（lib目录）
  - 添加 prepublishOnly 脚本，确保发布前自动构建
  - 修复模块导入错误

### v1.0.3
- 变更验证码发送方式：从私聊发送改为群内直接发送
- 优化验证流程，提高用户体验
- 修复相关消息处理逻辑
- 更新验证码发送格式：
  ```
  欢迎加入日常分享群～进群请发：
  【验证码】
  发完即可畅聊，禁止广告、刷屏、引战。
  ```
- 设置验证码时长默认为5分钟（300秒）
- 添加超级管理员指令功能：
  - `verify enable` - 开启群验证
  - `verify disable` - 关闭群验证
  - `verify mode <mode>` - 切换验证方式（captcha/image-captcha/whitelist）
  - `verify timeout <seconds>` - 设置验证码时长
  - `verify whitelist add <userId> [remark]` - 添加白名单
  - `verify whitelist remove <userId>` - 移除白名单
  - `verify whitelist list` - 查看白名单
  - `verify audit` - 查询验证记录
- 管理员可以通过指令控制群验证功能，无需进入控制台

### v1.0.2
- 修复依赖版本问题，移除对 @koishijs/plugin-database 的直接依赖
- 优化依赖配置，确保与 Koishi v4 兼容
- 修复市场插件解析错误

### v1.0.1
- 添加作者邮箱：kate522@88.com
- 添加 GitHub 仓库地址：https://github.com/Lexo0522/koishi-plugin-qq-group-join-verification
- 优化 README.md 文档结构

### v1.0.0
- 初始版本
- 支持多群独立配置
- 支持多种验证模式（白名单、文本验证码、图片验证码）
- 支持群内用户免验证
- 支持超时拒绝
- 支持白名单系统
- 支持验证记录（审计）
- 支持多适配器兼容
- 支持 Console 可视化后台

## 📦 安装

### 方法一：通过 Npm 安装

```bash
npm install koishi-plugin-qq-group-join-verification
```

### 方法二：手动安装

将 `koishi-plugin-qq-group-join-verification` 目录复制到 Koishi 的 `plugins` 目录中。

### 方法三：本地开发和测试

1. **克隆或复制插件目录**到 Koishi 实例的根目录
2. **安装依赖**：
   ```bash
   cd koishi-plugin-qq-group-join-verification
   npm install
   ```
3. **构建插件**：
   ```bash
   npm run build
   ```
4. **在主项目中链接本地插件**：
   ```bash
   npm install file:./koishi-plugin-qq-group-join-verification
   ```
5. **重启 Koishi**，插件将被加载

### 开发流程

1. 修改 `src` 目录中的源代码
2. 运行 `npm run build` 重新构建插件
3. 重启 Koishi 或使用热重载功能查看更改效果

## 🚀 快速开始

### 1. 启用插件

在 Koishi 配置文件中启用插件，并确保已启用以下插件：
- `@koishijs/plugin-database`（数据库支持）
- `@koishijs/plugin-console`（控制台支持）

### 2. 配置插件

打开 Koishi 控制台，进入「QQ 群加入验证」页面：

#### 群配置
- **选择群聊**：选择需要配置的群
- **验证模式**：
  - `whitelist`：仅白名单通过
  - `captcha`：随机文本验证码
  - `image-captcha`：SVG 图片验证码（带干扰线、噪点）
- **验证码长度**：设置验证码的长度（3-8位）
- **超时时间**：设置验证超时时间（秒）
- **跳过群内用户**：已在群内的用户直接通过，不进入验证流程
- **自定义消息模板**：
  - `{captcha}`：验证码
  - `{timeout}`：超时秒数

#### 白名单管理
- **添加白名单**：输入用户 ID 和备注，点击「添加白名单」
- **删除白名单**：点击白名单列表中的「删除」按钮

## ✨ 功能特性

### 多群独立配置
- 每个群可独立设置验证模式、验证码长度、超时时间等
- 配置持久化到数据库
- 支持自定义验证消息模板

### 多种验证模式
- **whitelist**：仅白名单通过
- **captcha**：随机文本验证码
- **image-captcha**：SVG 图片验证码（带干扰线、噪点）

### 智能验证
- **群内用户免验证**：调用 API 检查用户是否已在群内，是则直接通过
- **超时拒绝**：每个加群申请独立计时，超时未回复自动拒绝
- **白名单系统**：白名单用户直接通过，无需验证
- **自动验证**：可配置是否启用自动验证

### 性能优化
- **缓存机制**：群配置缓存，减少数据库查询次数
- **高效验证码**：优化验证码生成和验证流程
- **减少重复操作**：避免不必要的数据库查询和计算

### 安全性增强
- **验证码尝试次数限制**：防止暴力破解
- **尝试次数时间重置**：超过一定时间后重置尝试次数
- **输入参数验证**：严格验证用户输入，防止恶意请求

### 审计功能
- **验证记录**：记录群号、用户、验证类型、结果、时间
- **用于排查、统计**：可查询验证历史，分析验证通过率

### 多适配器兼容
- **adapter-onebot**：支持 OneBot 协议适配器
- **adapter-red**：支持 Red 协议适配器
- **adapter-milky**：支持 Milky 协议适配器
- **多种事件格式**：支持不同适配器的事件格式

### 可视化后台
- **Koishi Console**：Vue3 配置面板
- **群配置编辑**：切换群、保存配置
- **白名单管理**：增删查
- **验证记录查询**：查看验证历史

### 超级管理员指令
- **verify enable** - 开启群验证
- **verify disable** - 关闭群验证
- **verify mode <mode>** - 切换验证方式（captcha/image-captcha/whitelist）
- **verify timeout <seconds>** - 设置验证码时长（60-3600秒）
- **verify whitelist add <userId> [remark]** - 添加白名单
- **verify whitelist remove <userId>** - 移除白名单
- **verify whitelist list** - 查看白名单
- **verify audit** - 查询最近10条验证记录
- **verify admin add <userId> [remark]** - 添加超级管理员
- **verify admin remove <userId>** - 移除超级管理员
- **verify admin list** - 查看超级管理员
- **verify status** - 查看当前群验证状态详情
- **verify help** - 查看完整的指令帮助信息

## 🛠 技术实现

### 后端
- **语言**：TypeScript 5.3.0 + Node.js
- **框架**：Koishi v4.18.10
- **数据库**：基于 @koishijs/plugin-database，支持 SQLite / MySQL
- **图片验证码**：svg-captcha（轻量、跨平台、Base64 直接发送）
- **缓存机制**：使用 Map 实现的内存缓存，减少数据库查询
- **安全性**：验证码尝试次数限制，防止暴力破解
- **稳定性**：插件卸载时自动清理定时器，防止内存泄漏
- **容错能力**：图片验证码发送失败时自动降级为文本验证码
- **性能优化**：为数据库表添加索引，实现分页查询，提升查询性能
- **可靠性**：重复请求处理，复用原有验证码并重置超时定时器
- **健壮性**：数据库服务存在性检查，避免空指针错误

### 前端
- **框架**：Vue3 + Koishi Console 5.30.11
- **组件**：Element Plus
- **API**：Koishi Console API
- **路由**：独立的插件配置页面

### 构建工具
- **TypeScript**：5.3.0
- **copyfiles**：2.4.1（用于复制 Vue 文件到构建目录）
- **构建流程**：自动编译 TypeScript 并复制 Vue 文件

### 核心流程
1. 收到加群请求
2. 解析请求，获取群号、用户 ID、标识
3. 加载该群独立配置（使用缓存机制，提高性能）
4. 检查是否已在群内 → 直接通过
5. 检查白名单 → 直接通过
6. 生成验证码（文本 / 图片），缓存，设置超时
7. 群内直接发送验证码
8. 监听群内消息，校验验证码
9. 通过 → 同意加群；失败 → 拒绝；超时 → 自动拒绝
10. 所有结果写入验证记录
11. 验证码尝试次数限制，防止暴力破解

## 📁 目录结构

```
/
├── src/
│   ├── index.ts                 # 插件入口，注册事件、Console、数据库
│   ├── service.ts               # 核心业务逻辑：加群处理、验证码、超时、验证
│   ├── adapter/
│   │   └── index.ts             # 适配器兼容层：统一 approve/reject/解析请求
│   ├── db/
│   │   ├── model.ts             # 数据库模型（白名单、群配置、验证记录）
│   │   └── service.ts           # 数据库 CRUD 封装
│   ├── utils/
│   │   └── captcha.ts           # 文本/图片验证码生成、校验、缓存
│   └── client/
│       ├── index.ts             # Console 路由、API、页面注册
│       ├── pages/
│       │   └── config.vue       # 多群配置 + 白名单管理前端页面
│       └── vite-env.d.ts        # Vite 环境类型定义
├── types/
│   ├── index.ts                 # 类型定义文件
│   ├── index.js                 # 编译后的类型定义
│   └── index.d.ts               # 类型声明文件
├── package.json                 # 项目配置文件
├── package-lock.json            # NPM 依赖锁文件
├── tsconfig.json                # TypeScript 配置文件
├── README.md                    # 项目说明文档
├── .gitignore                   # Git 忽略文件
└── lib/                         # 编译后的代码（构建产物）
```

## 🎯 使用场景

1. **防止广告机器人**：通过验证码过滤机器人群
2. **提高群聊质量**：确保加入群聊的用户是真实用户
3. **管理群聊成员**：通过白名单系统控制群成员质量
4. **审计需求**：记录所有加群验证记录，便于后续排查

## 🔧 常见问题

### 1. 验证码发送失败
- **原因**：机器人无法发送私聊消息
- **解决方案**：确保机器人有发送私聊消息的权限

### 2. 加群请求处理失败
- **原因**：机器人没有群管理权限
- **解决方案**：确保机器人有群管理权限，能够处理加群请求

### 3. 适配器不兼容
- **原因**：使用了未适配的适配器
- **解决方案**：修改 `src/adapter/index.ts` 文件，添加对该适配器的支持

### 4. 数据库连接失败
- **原因**：数据库配置错误
- **解决方案**：检查 `@koishijs/plugin-database` 插件的配置

## 📄 许可证

MIT License

## 👨‍💻 作者

- **姓名**：kate522
- **邮箱**：kate522@88.com
- **GitHub**：[Lexo0522](https://github.com/Lexo0522)

## 🤝 贡献

欢迎提交 Issue 和 Pull Request，共同改进插件功能。

## 📞 联系方式

如有问题，请在 GitHub 上提交 Issue，或发送邮件至 kate522@88.com。

## 🔗 相关链接

- **GitHub 仓库**：[koishi-plugin-qq-group-join-verification](https://github.com/Lexo0522/koishi-plugin-qq-group-join-verification)
- **Npm 包**：[koishi-plugin-qq-group-join-verification](https://www.npmjs.com/package/koishi-plugin-qq-group-join-verification)

---

**Koishi 插件：QQ 群加入验证** - 让群聊管理更智能、更安全！